<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>香港巴士及電車實時位置追蹤</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
        }
        
        #map {
            height: calc(100vh - 60px);
            width: 100%;
        }
        
        .header {
            height: 60px;
            background-color: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 15px;
        }
        
        .vehicle-marker {
            border-radius: 50%;
            width: 12px;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 8px;
            color: white;
        }
        
        .bus {
            background-color: #e74c3c;
        }
        
        .tram {
            background-color: #2ecc71;
        }
        
        .settings-panel {
            position: absolute;
            top: 70px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 250px;
        }
        
        .dark-mode {
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        
        .dark-mode .settings-panel {
            background-color: #2d2d2d;
            color: #f0f0f0;
        }
        
        .dark-mode .header {
            background-color: #0a58ca;
        }
        
        .dark-mode .form-select, .dark-mode .form-check-input {
            background-color: #3d3d3d;
            color: #f0f0f0;
            border-color: #555;
        }
        
        .update-btn {
            position: absolute;
            top: 70px;
            left: 10px;
            z-index: 1000;
        }
        
        .vehicle-info {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .last-update {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .dark-mode .last-update {
            background-color: rgba(45, 45, 45, 0.8);
            color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h4 class="mb-0">香港巴士及電車實時位置追蹤</h4>
    </div>
    
    <button class="btn btn-primary update-btn" id="updateBtn">
        <span id="updateText">立即更新</span>
        <span class="spinner-border spinner-border-sm d-none" id="updateSpinner"></span>
    </button>
    
    <div class="settings-panel">
        <h5>設定</h5>
        <div class="mb-3">
            <label class="form-label">語言</label>
            <select class="form-select" id="languageSelect">
                <option value="zh-HK">繁體中文</option>
                <option value="zh-CN">简体中文</option>
                <option value="en">English</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">主題</label>
            <div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="theme" id="lightTheme" value="light" checked>
                    <label class="form-check-label" for="lightTheme">淺色</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="theme" id="darkTheme" value="dark">
                    <label class="form-check-label" for="darkTheme">深色</label>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">顯示車輛</label>
            <div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="showBuses" checked>
                    <label class="form-check-label" for="showBuses">巴士</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="showTrams" checked>
                    <label class="form-check-label" for="showTrams">電車</label>
                </div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="last-update" id="lastUpdate">
        最後更新: <span id="updateTime">--</span>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // 語言資源
        const translations = {
            'zh-HK': {
                title: '香港巴士及電車實時位置追蹤',
                updateBtn: '立即更新',
                lastUpdate: '最後更新',
                settings: '設定',
                language: '語言',
                theme: '主題',
                light: '淺色',
                dark: '深色',
                showVehicles: '顯示車輛',
                buses: '巴士',
                trams: '電車',
                loading: '更新中...',
                vehicleInfo: '車輛資訊',
                route: '路線',
                licensePlate: '車牌',
                model: '型號',
                direction: '方向',
                speed: '速度',
                lastReport: '最後報告時間',
                noData: '暫無數據'
            },
            'zh-CN': {
                title: '香港巴士及电车实时位置追踪',
                updateBtn: '立即更新',
                lastUpdate: '最后更新',
                settings: '设置',
                language: '语言',
                theme: '主题',
                light: '浅色',
                dark: '深色',
                showVehicles: '显示车辆',
                buses: '巴士',
                trams: '电车',
                loading: '更新中...',
                vehicleInfo: '车辆信息',
                route: '路线',
                licensePlate: '车牌',
                model: '型号',
                direction: '方向',
                speed: '速度',
                lastReport: '最后报告时间',
                noData: '暂无数据'
            },
            'en': {
                title: 'Hong Kong Bus & Tram Real-time Tracking',
                updateBtn: 'Update Now',
                lastUpdate: 'Last Update',
                settings: 'Settings',
                language: 'Language',
                theme: 'Theme',
                light: 'Light',
                dark: 'Dark',
                showVehicles: 'Show Vehicles',
                buses: 'Buses',
                trams: 'Trams',
                loading: 'Updating...',
                vehicleInfo: 'Vehicle Info',
                route: 'Route',
                licensePlate: 'License Plate',
                model: 'Model',
                direction: 'Direction',
                speed: 'Speed',
                lastReport: 'Last Report',
                noData: 'No Data'
            }
        };

        // 初始化變量
        let map;
        let vehicleMarkers = [];
        let currentLanguage = 'zh-HK';
        let currentTheme = 'light';
        let updateInterval;
        let isUpdating = false;

        // 初始化地圖
        function initMap() {
            // 香港中心坐標
            const hongKongCenter = [22.3193, 114.1694];
            
            // 初始化地圖
            map = L.map('map').setView(hongKongCenter, 12);
            
            // 添加地圖圖層
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // 添加深色地圖圖層（備用）
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>'
            });
        }

        // 生成模擬車輛數據
        function generateVehicleData() {
            const busModels = ['E500MMC', 'E400', 'Volvo B8L', 'V6B'];
            const tramModels = ['第七代電車', '第六代電車'];
            
            const vehicles = [];
            
            // 生成巴士數據
            for (let i = 0; i < 40; i++) {
                const routeNumber = Math.floor(Math.random() * 200) + 1;
                const licensePlate = `BUS${String(Math.floor(Math.random() * 9000) + 1000)}`;
                const model = busModels[Math.floor(Math.random() * busModels.length)];
                
                // 隨機香港位置
                const lat = 22.25 + Math.random() * 0.2;
                const lng = 114.1 + Math.random() * 0.2;
                
                vehicles.push({
                    id: `bus_${i}`,
                    type: 'bus',
                    route: `${routeNumber}`,
                    licensePlate: licensePlate,
                    model: model,
                    lat: lat,
                    lng: lng,
                    direction: Math.floor(Math.random() * 360),
                    speed: Math.floor(Math.random() * 50) + 10,
                    lastReport: new Date()
                });
            }
            
            // 生成電車數據
            for (let i = 0; i < 15; i++) {
                const routeNumber = ['上環 ↔ 筲箕灣', '堅尼地城 ↔ 筲箕灣', '跑馬地 ↔ 筲箕灣'][Math.floor(Math.random() * 3)];
                const licensePlate = `TRAM${String(Math.floor(Math.random() * 900) + 100)}`;
                const model = tramModels[Math.floor(Math.random() * tramModels.length)];
                
                // 沿電車路線隨機位置
                const lat = 22.28 + Math.random() * 0.05;
                const lng = 114.15 + Math.random() * 0.1;
                
                vehicles.push({
                    id: `tram_${i}`,
                    type: 'tram',
                    route: routeNumber,
                    licensePlate: licensePlate,
                    model: model,
                    lat: lat,
                    lng: lng,
                    direction: Math.floor(Math.random() * 360),
                    speed: Math.floor(Math.random() * 15) + 5,
                    lastReport: new Date()
                });
            }
            
            return vehicles;
        }

        // 更新地圖上的車輛標記
        function updateVehicleMarkers(vehicles) {
            // 清除現有標記
            vehicleMarkers.forEach(marker => map.removeLayer(marker));
            vehicleMarkers = [];
            
            // 獲取顯示設置
            const showBuses = document.getElementById('showBuses').checked;
            const showTrams = document.getElementById('showTrams').checked;
            
            // 添加新標記
            vehicles.forEach(vehicle => {
                if ((vehicle.type === 'bus' && !showBuses) || (vehicle.type === 'tram' && !showTrams)) {
                    return;
                }
                
                // 創建自定義圖標
                const vehicleIcon = L.divIcon({
                    className: `vehicle-marker ${vehicle.type}`,
                    html: vehicle.type === 'bus' ? 'B' : 'T',
                    iconSize: [12, 12]
                });
                
                // 創建標記
                const marker = L.marker([vehicle.lat, vehicle.lng], { icon: vehicleIcon })
                    .addTo(map);
                
                // 創建彈出窗口內容
                const popupContent = `
                    <div>
                        <h6>${translations[currentLanguage].vehicleInfo}</h6>
                        <div class="vehicle-info"><strong>${translations[currentLanguage].route}:</strong> ${vehicle.route}</div>
                        <div class="vehicle-info"><strong>${translations[currentLanguage].licensePlate}:</strong> ${vehicle.licensePlate}</div>
                        <div class="vehicle-info"><strong>${translations[currentLanguage].model}:</strong> ${vehicle.model}</div>
                        <div class="vehicle-info"><strong>${translations[currentLanguage].direction}:</strong> ${vehicle.direction}°</div>
                        <div class="vehicle-info"><strong>${translations[currentLanguage].speed}:</strong> ${vehicle.speed} km/h</div>
                        <div class="vehicle-info"><strong>${translations[currentLanguage].lastReport}:</strong> ${vehicle.lastReport.toLocaleTimeString()}</div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                vehicleMarkers.push(marker);
            });
        }

        // 模擬從運輸署API獲取數據
        function fetchVehicleData() {
            // 模擬API延遲
            return new Promise(resolve => {
                setTimeout(() => {
                    const data = generateVehicleData();
                    resolve(data);
                }, 1000);
            });
        }

        // 更新車輛位置
        async function updateVehiclePositions() {
            if (isUpdating) return;
            
            isUpdating = true;
            document.getElementById('updateSpinner').classList.remove('d-none');
            document.getElementById('updateText').textContent = translations[currentLanguage].loading;
            document.getElementById('updateBtn').disabled = true;
            
            try {
                const vehicleData = await fetchVehicleData();
                updateVehicleMarkers(vehicleData);
                
                // 更新最後更新時間
                const now = new Date();
                document.getElementById('updateTime').textContent = now.toLocaleTimeString();
            } catch (error) {
                console.error('更新數據時出錯:', error);
            } finally {
                isUpdating = false;
                document.getElementById('updateSpinner').classList.add('d-none');
                document.getElementById('updateText').textContent = translations[currentLanguage].updateBtn;
                document.getElementById('updateBtn').disabled = false;
            }
        }

        // 切換語言
        function changeLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('languageSelect').value = lang;
            
            // 更新界面文字
            document.querySelector('.header h4').textContent = translations[lang].title;
            document.getElementById('updateText').textContent = translations[lang].updateBtn;
            document.querySelector('.settings-panel h5').textContent = translations[lang].settings;
            document.querySelector('label[for="languageSelect"]').textContent = translations[lang].language;
            document.querySelector('label[for="lightTheme"]').textContent = translations[lang].light;
            document.querySelector('label[for="darkTheme"]').textContent = translations[lang].dark;
            document.querySelector('label[for="showBuses"]').textContent = translations[lang].buses;
            document.querySelector('label[for="showTrams"]').textContent = translations[lang].trams;
            document.getElementById('lastUpdate').innerHTML = `${translations[lang].lastUpdate}: <span id="updateTime">--</span>`;
            
            // 重新加載數據以更新彈出窗口內容
            updateVehiclePositions();
        }

        // 切換主題
        function changeTheme(theme) {
            currentTheme = theme;
            
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                // 切換到深色地圖
                map.eachLayer(layer => {
                    if (layer instanceof L.TileLayer && layer._url.includes('openstreetmap')) {
                        map.removeLayer(layer);
                    }
                });
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>'
                }).addTo(map);
            } else {
                document.body.classList.remove('dark-mode');
                // 切換到淺色地圖
                map.eachLayer(layer => {
                    if (layer instanceof L.TileLayer && layer._url.includes('cartocdn')) {
                        map.removeLayer(layer);
                    }
                });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            }
        }

        // 初始化應用
        function initApp() {
            initMap();
            
            // 設置事件監聽器
            document.getElementById('updateBtn').addEventListener('click', updateVehiclePositions);
            document.getElementById('languageSelect').addEventListener('change', (e) => changeLanguage(e.target.value));
            document.getElementById('lightTheme').addEventListener('change', (e) => changeTheme('light'));
            document.getElementById('darkTheme').addEventListener('change', (e) => changeTheme('dark'));
            document.getElementById('showBuses').addEventListener('change', updateVehiclePositions);
            document.getElementById('showTrams').addEventListener('change', updateVehiclePositions);
            
            // 初始加載數據
            updateVehiclePositions();
            
            // 設置定時更新（每2分鐘）
            updateInterval = setInterval(updateVehiclePositions, 2 * 60 * 1000);
        }

        // 當頁面加載完成後初始化應用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
  </html>
